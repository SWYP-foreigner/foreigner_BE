<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat UI â€” Demo</title>
    <style>
        :root{--bg:#0f1720;--panel:#0b1220;--muted:#94a3b8;--accent:#06b6d4;--glass:rgba(255,255,255,0.03)}
        html,body{height:100%;margin:0;background:linear-gradient(180deg,#071124 0%, #071933 100%);font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#e6eef6}
        .app{display:flex;height:100vh;gap:18px;padding:18px;box-sizing:border-box}

        /* left: rooms */
        .rooms{width:320px;background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);display:flex;flex-direction:column;gap:10px}
        .rooms h2{margin:0;font-size:16px}
        .searchBox{display:flex;gap:8px}
        .searchBox input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
        .btn{background:var(--accent);color:#022;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
        .roomsList{overflow:auto;flex:1;padding-top:6px}
        .roomItem{padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;cursor:pointer}
        .roomItem:hover{background:rgba(255,255,255,0.02)}
        .roomMeta{font-size:13px;color:var(--muted)}

        /* center: messages */
        .chat{flex:1;display:flex;flex-direction:column;background:var(--panel);border-radius:12px;padding:12px;gap:12px}
        .chatHeader{display:flex;justify-content:space-between;align-items:center}
        .messages{flex:1;overflow:auto;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:8px}
        .msg{padding:8px 12px;margin:8px 0;border-radius:12px;max-width:70%;word-break:break-word}
        .msg.me{background:linear-gradient(90deg,#096b77,#06b6d4);color:#001821;margin-left:auto}
        .msg.others{background:rgba(255,255,255,0.03)}
        .msg .meta{font-size:11px;color:var(--muted);margin-bottom:6px}

        .composer{display:flex;gap:8px}
        .composer input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

        /* right: tools */
        .tools{width:300px;background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
        .small{font-size:13px;color:var(--muted)}
        .msgActions{display:flex;gap:6px}
        .iconBtn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:var(--muted);cursor:pointer}

        /* responsive */
        @media (max-width:900px){.rooms{display:none}.tools{display:none}}
    </style>
</head>
<body>
<div class="app">
    <aside class="rooms">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h2>ì±„íŒ…ë°©</h2>
            <button id="btnCreateRoom" class="btn">ìƒˆ ë°©</button>
        </div>

        <div class="searchBox">
            <input id="roomSearch" placeholder="ë°© ê²€ìƒ‰ ë˜ëŠ” ìœ ì € ê²€ìƒ‰" />
            <button id="btnSearchRoom" class="iconBtn">ğŸ”</button>
        </div>

        <div class="roomsList" id="roomsList">
            <!-- room items injected here -->
        </div>
    </aside>

    <main class="chat">
        <div class="chatHeader">
            <div>
                <div id="roomTitle">ì„ íƒëœ ì±„íŒ…ë°© ì—†ìŒ</div>
                <div class="small" id="roomSubtitle">1:1 or ê·¸ë£¹</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <input id="msgSearch" placeholder="ë©”ì‹œì§€ ê²€ìƒ‰" />
                <button id="btnSearchMsg" class="iconBtn">ğŸ”</button>
                <button id="btnDeleteRoom" class="iconBtn">ë°© ì‚­ì œ</button>
            </div>
        </div>

        <div class="messages" id="messages">
            <!-- messages go here -->
        </div>

        <div class="composer">
            <input id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            <button id="btnSend" class="btn">ì „ì†¡</button>
        </div>
    </main>

    <aside class="tools">
        <div>
            <strong>í™œì„± ë°© ì •ë³´</strong>
            <div class="small" id="activeRoomInfo">ì—†ìŒ</div>
        </div>

        <div>
            <strong>ë„ì›€ë§</strong>
            <div class="small">- ë©”ì‹œì§€ í´ë¦­ ì‹œ ì‚­ì œ ì•„ì´ì½˜ í‘œì‹œ
                - ëª¨ë°”ì¼ì€ WebSocket ê¶Œì¥
                - API ì—”ë“œí¬ì¸íŠ¸ëŠ” /api/rooms, /api/rooms/:id/messages</div>
        </div>
    </aside>
</div>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    // ====== ì„¤ì • (ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ & í˜„ì¬ ìœ ì €) ======
    const API_BASE = 'http://localhost:8080/api/v1'; // NOTE: /chat ë¶€ë¶„ì„ ê° API ê²½ë¡œì— í¬í•¨ì‹œí‚´
    const WS_ENDPOINT = '/ws'; // NOTE: SockJS ì—”ë“œí¬ì¸íŠ¸
    const currentUser = { id: 1, name: 'me' }; // NOTE: ì‹¤ì œ ë¡œê·¸ì¸ ìœ ì € ì •ë³´ë¡œ ëŒ€ì²´ í•„ìš”

    // ====== ì•± ìƒíƒœ ê´€ë¦¬ ======
    const state = {
        rooms: [],
        activeRoomId: null,
        stompClient: null,
    };

    // ====== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ======
    function el(tag, props = {}, ...children) {
        const node = document.createElement(tag);
        Object.entries(props).forEach(([key, value]) => {
            if (key.startsWith('on')) {
                node.addEventListener(key.slice(2).toLowerCase(), value);
            } else {
                node[key] = value;
            }
        });
        children.forEach(child => {
            if (typeof child === 'string') {
                node.appendChild(document.createTextNode(child));
            } else if (child) {
                node.appendChild(child);
            }
        });
        return node;
    }

    // ====== ì±„íŒ…ë°© (Rooms) ê´€ë ¨ í•¨ìˆ˜ ======
    async function loadRooms(query = '') {
        try {
            const res = await fetch(`${API_BASE}/chat/rooms?q=${encodeURIComponent(query)}`);
            if (!res.ok) throw new Error(`Rooms fetch error: ${res.statusText}`);
            const result = await res.json();
            state.rooms = result.data || [];
        } catch (e) {
            console.error('Failed to load rooms', e);
            state.rooms = [];
            alert('ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        renderRooms();
    }

    function renderRooms() {
        const container = document.getElementById('roomsList');
        container.innerHTML = '';
        state.rooms.forEach(room => {
            const item = el('div', {
                    className: `roomItem ${room.id === state.activeRoomId ? 'active' : ''}`,
                    onclick: () => openRoom(room.id)
                },
                el('div', {}, room.title || '(ì œëª© ì—†ìŒ)'),
                el('div', { className: 'roomMeta' }, room.type || '')
            );
            const delBtn = el('button', {
                className: 'iconBtn',
                onclick: (ev) => {
                    ev.stopPropagation();
                    deleteRoom(room.id);
                }
            }, 'ğŸ—‘');
            item.appendChild(delBtn);
            container.appendChild(item);
        });
    }

    async function createRoom() {
        const isGroup = confirm('ê·¸ë£¹ ì±„íŒ…ë°©ì¸ê°€ìš”? (ì·¨ì†Œí•˜ë©´ 1:1 ì±„íŒ…ë°©)');
        const participantInput = prompt(isGroup ? 'ì°¸ì—¬ì IDë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2,3,4)' : 'ìƒëŒ€ë°©ì˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        if (!participantInput) return alert('ì°¸ì—¬ì IDë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');

        const participantIds = participantInput.split(',').map(id => Number(id.trim()));
        if (!isGroup) {
            participantIds.push(currentUser.id); // 1:1 ì±„íŒ… ì‹œ ìì‹ ì„ í¬í•¨
        }

        const body = participantIds.map(id => ({ id }));

        try {
            const res = await fetch(`${API_BASE}/chat/rooms?isGroup=${isGroup}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!res.ok) throw new Error(`Create room failed: ${res.statusText}`);

            const result = await res.json();
            const newRoom = result.data;
            state.rooms.unshift(newRoom);
            renderRooms();
            openRoom(newRoom.id);
        } catch (e) {
            console.error('Failed to create room', e);
            alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function deleteRoom(roomId) {
        if (!confirm('ì •ë§ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const res = await fetch(`${API_BASE}/chat/rooms/${roomId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(`Delete room failed: ${res.statusText}`);

            state.rooms = state.rooms.filter(r => r.id !== roomId);
            if (state.activeRoomId === roomId) {
                closeRoom();
            }
            renderRooms();
        } catch (e) {
            console.error('Failed to delete room', e);
            alert('ì±„íŒ…ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ====== ë©”ì‹œì§€ (Messages) ê´€ë ¨ í•¨ìˆ˜ ======
    async function openRoom(roomId) {
        if (state.activeRoomId === roomId) return;

        state.activeRoomId = roomId;
        const room = state.rooms.find(r => r.id === roomId);

        document.getElementById('roomTitle').innerText = room?.title || 'ëŒ€í™”ë°©';
        document.getElementById('roomSubtitle').innerText = room?.type || '';
        document.getElementById('messages').innerHTML = 'ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

        renderRooms(); // í™œì„±í™”ëœ ë°© UI ì—…ë°ì´íŠ¸
        await loadMessages(roomId);
        connectWs(roomId);
    }

    function closeRoom() {
        state.activeRoomId = null;
        document.getElementById('roomTitle').innerText = 'ì„ íƒëœ ì±„íŒ…ë°© ì—†ìŒ';
        document.getElementById('roomSubtitle').innerText = '';
        document.getElementById('messages').innerHTML = '';
        if (state.stompClient) {
            state.stompClient.disconnect();
            state.stompClient = null;
        }
    }

    async function loadMessages(roomId, query = '') {
        try {
            const res = await fetch(`${API_BASE}/chat/rooms/${roomId}/messages?q=${encodeURIComponent(query)}`);
            if (!res.ok) throw new Error(`Load messages failed: ${res.statusText}`);
            const messages = await res.json(); // API ì‘ë‹µì´ ë©”ì‹œì§€ ëª©ë¡ ìì²´ë¼ê³  ê°€ì •
            renderMessages(messages.data || []);
        } catch (e) {
            console.error('Failed to load messages', e);
            document.getElementById('messages').innerHTML = '<div class="error">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // NEW: ë©”ì‹œì§€ DOM ìš”ì†Œë¥¼ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function createMessageElement(message) {
        const isMe = message.senderId === currentUser.id;
        const senderName = message.senderName || 'Anonymity';
        const time = message.createdAt ? new Date(message.createdAt).toLocaleTimeString() : '';

        return el('div', { className: `msg ${isMe ? 'me' : 'others'}`, 'data-message-id': message.id },
            el('div', { className: 'meta' }, `${senderName} â€¢ ${time}`),
            el('div', {}, message.content || ''),
            el('div', { className: 'msgActions' },
                el('button', { className: 'iconBtn', onclick: () => deleteMessage(message.id) }, 'ì‚­ì œ')
            )
        );
    }


    function renderMessages(messages) {
        const box = document.getElementById('messages');
        box.innerHTML = '';
        messages.forEach(msg => box.appendChild(createMessageElement(msg)));
        box.scrollTop = box.scrollHeight;
    }

    function appendMessage(message) {
        const box = document.getElementById('messages');
        box.appendChild(createMessageElement(message));
        box.scrollTop = box.scrollHeight;
    }

    // FIXED: sendMessage í•¨ìˆ˜ í†µí•©
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text || !state.activeRoomId) return;

        const payload = {
            roomId: state.activeRoomId,
            senderId: currentUser.id,
            content: text
        };

        // WebSocketì´ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ STOMPë¡œ ì „ì†¡
        if (state.stompClient && state.stompClient.connected) {
            state.stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(payload));
            input.value = '';
        } else {
            // ì—°ê²° ì•ˆë˜ì–´ ìˆìœ¼ë©´ HTTP POSTë¡œ ì „ì†¡ (í´ë°±)
            console.warn("WebSocket not connected. Sending via HTTP.");
            try {
                const res = await fetch(`${API_BASE}/chat/rooms/${state.activeRoomId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Send message via HTTP failed');
                const savedMessage = await res.json();
                appendMessage(savedMessage.data);
                input.value = '';
            } catch (e) {
                console.error('Failed to send message via HTTP', e);
                alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }
    }

    async function deleteMessage(messageId) {
        if (!confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const res = await fetch(`${API_BASE}/chat/messages/${messageId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Delete message failed');

            // CHANGED: ì „ì²´ ë¦¬ë¡œë“œ ëŒ€ì‹  í•´ë‹¹ ë©”ì‹œì§€ DOMë§Œ ì œê±°
            const msgElement = document.querySelector(`[data-message-id='${messageId}']`);
            if (msgElement) {
                msgElement.remove();
            }
        } catch (e) {
            console.error('Failed to delete message', e);
            alert('ë©”ì‹œì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ====== WebSocket ê´€ë ¨ í•¨ìˆ˜ ======
    function connectWs(roomId) {
        if (state.stompClient) {
            state.stompClient.disconnect();
        }

        const socket = new SockJS(WS_ENDPOINT);
        state.stompClient = Stomp.over(socket);

        state.stompClient.connect({}, (frame) => {
            console.log('Connected: ' + frame);
            state.stompClient.subscribe(`/topic/rooms/${roomId}`, (message) => {
                const newMessage = JSON.parse(message.body);
                // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” stompë¡œ ë°›ì§€ ì•Šê³  appendMessageì—ì„œ ë°”ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì¤‘ë³µ ë°©ì§€
                if(newMessage.from?.id !== currentUser.id){
                    appendMessage(newMessage);
                }
            });
        }, (error) => {
            console.error('STOMP connection error:', error);
        });
    }

    // ====== UI ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ======
    function initialize() {
        document.getElementById('btnCreateRoom').addEventListener('click', createRoom);
        document.getElementById('btnSend').addEventListener('click', sendMessage);

        document.getElementById('btnDeleteRoom').addEventListener('click', () => {
            if (state.activeRoomId) deleteRoom(state.activeRoomId);
        });

        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('btnSearchRoom').addEventListener('click', () => {
            loadRooms(document.getElementById('roomSearch').value.trim());
        });

        document.getElementById('btnSearchMsg').addEventListener('click', () => {
            const query = document.getElementById('msgSearch').value.trim();
            if (!state.activeRoomId) return alert('ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
            loadMessages(state.activeRoomId, query);
        });

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadRooms();
    }

    // DOMì´ ë¡œë“œëœ í›„ ì•± ì´ˆê¸°í™” ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', initialize);
</script>

</body>
</html>
