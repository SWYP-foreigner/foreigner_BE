<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat UI â€” Demo</title>
    <style>
        :root{--bg:#0f1720;--panel:#0b1220;--muted:#94a3b8;--accent:#06b6d4;--glass:rgba(255,255,255,0.03)}
        html,body{height:100%;margin:0;background:linear-gradient(180deg,#071124 0%, #071933 100%);font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#e6eef6}
        .app{display:flex;height:100vh;gap:18px;padding:18px;box-sizing:border-box}

        /* left: rooms */
        .rooms{width:320px;background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);display:flex;flex-direction:column;gap:10px}
        .rooms h2{margin:0;font-size:16px}
        .searchBox{display:flex;gap:8px}
        .searchBox input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
        .btn{background:var(--accent);color:#022;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
        .roomsList{overflow:auto;flex:1;padding-top:6px}
        .roomItem{padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;cursor:pointer}
        .roomItem:hover{background:rgba(255,255,255,0.02)}
        .roomMeta{font-size:13px;color:var(--muted)}

        /* center: messages */
        .chat{flex:1;display:flex;flex-direction:column;background:var(--panel);border-radius:12px;padding:12px;gap:12px}
        .chatHeader{display:flex;justify-content:space-between;align-items:center}
        .messages{flex:1;overflow:auto;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:8px}
        .msg{padding:8px 12px;margin:8px 0;border-radius:12px;max-width:70%;word-break:break-word}
        .msg.me{background:linear-gradient(90deg,#096b77,#06b6d4);color:#001821;margin-left:auto}
        .msg.others{background:rgba(255,255,255,0.03)}
        .msg .meta{font-size:11px;color:var(--muted);margin-bottom:6px}

        .composer{display:flex;gap:8px}
        .composer input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

        /* right: tools */
        .tools{width:300px;background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
        .small{font-size:13px;color:var(--muted)}
        .msgActions{display:flex;gap:6px}
        .iconBtn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:var(--muted);cursor:pointer}

        /* responsive */
        @media (max-width:900px){.rooms{display:none}.tools{display:none}}
    </style>
</head>
<body>
<div class="app">
    <aside class="rooms">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h2>ì±„íŒ…ë°©</h2>
            <button id="btnCreateRoom" class="btn">ìƒˆ ë°©</button>
        </div>

        <div class="searchBox">
            <input id="roomSearch" placeholder="ë°© ê²€ìƒ‰ ë˜ëŠ” ìœ ì € ê²€ìƒ‰" />
            <button id="btnSearchRoom" class="iconBtn">ğŸ”</button>
        </div>

        <div class="roomsList" id="roomsList">
            <!-- room items injected here -->
        </div>
    </aside>

    <main class="chat">
        <div class="chatHeader">
            <div>
                <div id="roomTitle">ì„ íƒëœ ì±„íŒ…ë°© ì—†ìŒ</div>
                <div class="small" id="roomSubtitle">1:1 or ê·¸ë£¹</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <input id="msgSearch" placeholder="ë©”ì‹œì§€ ê²€ìƒ‰" />
                <button id="btnSearchMsg" class="iconBtn">ğŸ”</button>
                <button id="btnDeleteRoom" class="iconBtn">ë°© ì‚­ì œ</button>
            </div>
        </div>

        <div class="messages" id="messages">
            <!-- messages go here -->
        </div>

        <div class="composer">
            <input id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            <button id="btnSend" class="btn">ì „ì†¡</button>
        </div>
    </main>

    <aside class="tools">
        <div>
            <strong>í™œì„± ë°© ì •ë³´</strong>
            <div class="small" id="activeRoomInfo">ì—†ìŒ</div>
        </div>

        <div>
            <strong>ë„ì›€ë§</strong>
            <div class="small">- ë©”ì‹œì§€ í´ë¦­ ì‹œ ì‚­ì œ ì•„ì´ì½˜ í‘œì‹œ
                - ëª¨ë°”ì¼ì€ WebSocket ê¶Œì¥
                - API ì—”ë“œí¬ì¸íŠ¸ëŠ” /api/rooms, /api/rooms/:id/messages</div>
        </div>
    </aside>
</div>

<script>
    // ====== ì„¤ì • (ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ & í˜„ì¬ ìœ ì €) ======
    const API_BASE = 'http://localhost:8080/api/v1/chat'; // í¬íŠ¸ì™€ ì£¼ì†Œë¥¼ ì‹¤ì œ ë°±ì—”ë“œì— ë§ê²Œ
    const WS_BASE = (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host + '/ws';
    const currentUser = { id: 1, name: 'me' }; // ì´ ë¶€ë¶„ì€ ì‹¤ì œ ë¡œê·¸ì¸ ìœ ì € ì •ë³´ë¡œ ëŒ€ì²´ í•„ìš”

    // ì•± ìƒíƒœ
    let rooms = []; // ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸
    let activeRoom = null;
    let ws = null;

    // ====== ìœ í‹¸ ======
    function el(tag, props = {}, ...children){
        const node = document.createElement(tag);
        Object.entries(props).forEach(([k,v]) => {
            if(k.startsWith('on')) node.addEventListener(k.slice(2).toLowerCase(), v);
            else node[k]=v
        });
        children.forEach(c => {
            if(typeof c === 'string') node.appendChild(document.createTextNode(c));
            else if(c) node.appendChild(c)
        });
        return node;
    }

    // ====== Rooms ======
    async function loadRooms(query){
        try{
            const res = await fetch(API_BASE + '/rooms' + (query ? ('?q=' + encodeURIComponent(query)) : ''));
            if(!res.ok) throw new Error('Rooms fetch error');
            const result = await res.json();  // ì „ì²´ ì‘ë‹µ ê°ì²´
            rooms = result.data || [];        // data í•„ë“œë§Œ êº¼ë‚´ì„œ ë°°ì—´ í• ë‹¹
        }catch(e){
            console.error('Failed to load rooms', e);
            rooms = []; // ì—ëŸ¬ ì‹œ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
        }
        renderRooms();
    }

    function renderRooms(){
        const container = document.getElementById('roomsList');
        container.innerHTML = '';
        rooms.forEach(r => {
            const item = el('div',{className:'roomItem',onclick:()=>openRoom(r.id)},
                el('div',{}, r.title || '(ì œëª© ì—†ìŒ)'),
                el('div',{className:'roomMeta'}, r.type || '')
            );
            const del = el('button',{className:'iconBtn',onclick:(ev)=>{ev.stopPropagation(); deleteRoom(r.id);} },'ğŸ—‘');
            item.appendChild(del);
            container.appendChild(item);
        });
    }

    async function createRoom(participantIds) {
        const isGroup = confirm('ê·¸ë£¹ ì±„íŒ…ë°©ì¸ê°€ìš”? (ì·¨ì†Œí•˜ë©´ 1:1 ì±„íŒ…ë°©)');
        const Ids = [participantIds, 2]; // ì˜ˆì‹œ


        try {
            const res = await fetch(API_BASE + '/rooms?isGroup=' + isGroup, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(Ids) // ì˜ˆ: [1, 2]
            });
            if (!res.ok) throw new Error('Create room failed');
            const result = await res.json();
            console.log(result);
            const room = result.data;
            rooms.unshift(room);
            renderRooms();
        } catch (e) {
            console.error('Failed to create room', e);
            alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function deleteRoom(roomId){
        if(!confirm('ì •ë§ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try{
            const res = await fetch(API_BASE + '/rooms/' + roomId, {method:'DELETE'});
            if(!res.ok) throw new Error('Delete room failed');
            rooms = rooms.filter(r=>r.id!==roomId);
            if(activeRoom && activeRoom.id===roomId) closeRoom();
            renderRooms();
        }catch(e){
            console.error('Failed to delete room', e);
            alert('ì±„íŒ…ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ====== Messages ======
    async function openRoom(roomId){
        activeRoom = rooms.find(r=>r.id===roomId) || {id:roomId,title:'(ë¡œë”© ì¤‘)',type:'DIRECT'};
        document.getElementById('roomTitle').innerText = activeRoom.title || 'ë¬´ì œ';
        document.getElementById('roomSubtitle').innerText = activeRoom.type || '';
        document.getElementById('activeRoomInfo').innerText = JSON.stringify(activeRoom);

        await loadMessages(roomId);
        connectWs(roomId);
    }

    function closeRoom(){
        activeRoom = null;
        document.getElementById('roomTitle').innerText = 'ì„ íƒëœ ì±„íŒ…ë°© ì—†ìŒ';
        document.getElementById('messages').innerHTML = '';
        if(ws){ ws.close(); ws = null; }
    }

    async function loadMessages(roomId, q){
        try{
            const res = await fetch(API_BASE + '/rooms/' + roomId + '/messages' + (q ? ('?q=' + encodeURIComponent(q)) : ''));
            if(!res.ok) throw new Error('Load messages failed');
            const list = await res.json();
            renderMessages(list);
        }catch(e){
            console.error('Failed to load messages', e);
            document.getElementById('messages').innerHTML = '';
        }
    }

    function renderMessages(list){
        const box = document.getElementById('messages');
        box.innerHTML = '';
        list.forEach(m => {
            const div = el('div',{className:'msg ' + (m.from?.id === currentUser.id ? 'me':'others')});
            const meta = el('div',{className:'meta'}, (m.from?.name || 'ìµëª…') + ' â€¢ ' + new Date(m.createdAt).toLocaleTimeString());
            div.appendChild(meta);
            const txt = el('div',{}, m.text || m.content || '');
            div.appendChild(txt);

            const actions = el('div',{className:'msgActions'});
            const btnDelete = el('button',{
                className:'iconBtn',
                onclick: async (ev) => { ev.stopPropagation(); await deleteMessage(m.id || m._id); }
            }, 'ì‚­ì œ');
            actions.appendChild(btnDelete);
            div.appendChild(actions);

            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    async function sendMessage(){
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if(!text || !activeRoom) return;

        const payload = { senderId: currentUser.id, content: text };

        try{
            const res = await fetch(API_BASE + '/rooms/' + activeRoom.id + '/messages', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });
            if(!res.ok) throw new Error('Send message failed');
            const saved = await res.json();
            appendMessage(saved);
            input.value = '';
        }catch(e){
            console.error('Failed to send message', e);
            alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function appendMessage(m){
        const box = document.getElementById('messages');
        const div = el('div',{className:'msg ' + (m.from?.id === currentUser.id ? 'me' : 'others')});
        const meta = el('div',{className:'meta'}, (m.from?.name || 'ìµëª…') + ' â€¢ ' + new Date(m.createdAt).toLocaleTimeString());
        div.appendChild(meta);
        div.appendChild(el('div', {}, m.text || m.content || ''));
        const actions = el('div',{className:'msgActions'});
        const btnDelete = el('button',{
            className:'iconBtn',
            onclick: async (ev) => { ev.stopPropagation(); await deleteMessage(m.id || m._id); }
        }, 'ì‚­ì œ');
        actions.appendChild(btnDelete);
        div.appendChild(actions);
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    async function deleteMessage(messageId){
        if(!confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try{
            const res = await fetch(API_BASE + '/messages/' + messageId, {method:'DELETE'});
            if(!res.ok) throw new Error('Delete message failed');
            if(activeRoom) await loadMessages(activeRoom.id);
        }catch(e){
            console.error('Failed to delete message', e);
            alert('ë©”ì‹œì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ====== Search ======
    document.getElementById('btnSearchRoom').addEventListener('click', () => {
        loadRooms(document.getElementById('roomSearch').value.trim());
    });
    document.getElementById('btnSearchMsg').addEventListener('click', () => {
        const q = document.getElementById('msgSearch').value.trim();
        if(!activeRoom) return alert('ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        loadMessages(activeRoom.id, q);
    });

    // ====== WebSocket ======
    function connectWs(roomId){
        if(ws){ ws.close(); ws = null; }
        try{
            ws = new WebSocket(WS_BASE + '?roomId=' + roomId + '&userId=' + currentUser.id);
            ws.addEventListener('open', () => console.log('WS open'));
            ws.addEventListener('message', e => {
                try{
                    const data = JSON.parse(e.data);
                    if(data.type === 'message') appendMessage(data.payload);
                }catch(err){
                    console.warn('ws parse error', err);
                }
            });
            ws.addEventListener('close', () => console.log('WS closed'));
        }catch(e){
            console.warn('WS connection failed', e);
        }
    }

    // ====== init UI handlers ======
    document.getElementById('btnCreateRoom').addEventListener('click', createRoom);
    document.getElementById('btnSend').addEventListener('click', sendMessage);
    document.getElementById('btnDeleteRoom').addEventListener('click', () => {
        if(activeRoom) deleteRoom(activeRoom.id);
    });

    // keyboard enter to send
    document.getElementById('messageInput').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') sendMessage();
    });

    // load initial rooms
    loadRooms();
</script>

</body>
</html>
